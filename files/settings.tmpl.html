{{ define "settings" }}
{{ template "head" . }}
{{ template "nav" . }}

<main class="content-page">
  {{ $length := len .Data.UrlsAndErrors }}
  
  <h3>Settings</h3>
  
  <p>your public url: <a href="/u/{{ .Username }}">mire.meadow.cafe/u/{{ .Username }}</a></p>
  <p>you can view your (public) blogroll here: <a href="/u/{{ .Username }}/blogroll">mire.meadow.cafe/u/{{ .Username }}/blogroll</a></p>

  <hr />

  <h4>Change Password</h4>
  <form method="POST" action="/settings/change-password">
    <div>
      <label for="currentPassword">Current Password:</label>
      <input type="password" name="currentPassword" id="currentPassword" required>
    </div>
    <br />
    <div>
      <label for="newPassword">New Password:</label>
      <input type="password" name="newPassword" id="newPassword" required>
    </div>
    <br />
    <div>
      <label for="confirmNewPassword">Confirm New Password:</label>
      <input type="password" name="confirmNewPassword" id="confirmNewPassword" required>
    </div>
    <br />
    <input type="submit" value="Change Password">
  </form>

  <hr />

  <h4>User Preferences</h4>
  <form method="POST" action="/settings/preferences">
    {{ $up := .Data.UserPreferences }}
    
    <div>
      <label for="numUnreadPostsToShowInHomeScreen">Number of unread posts to load in home screen (set to 0 to disable):</label>
      <input type="number" name="numUnreadPostsToShowInHomeScreen" id="numUnreadPostsToShowInHomeScreen"
        value="{{ $up.NumUnreadPostsToShowInHomeScreen }}" max="20" min="0">
    </div>
    <br />

    <div>
      <label for="numPostsToShowInHomeScreen">Number of posts to load in home screen:</label>
      <select name="numPostsToShowInHomeScreen" id="numPostsToShowInHomeScreen">
        {{ $numPostsOptions := makeSlice 50 100 150 200 300 }}
        {{ range $numPostsOptions }}
        <option value="{{ . }}" {{ if eq $up.NumPostsToShowInHomeScreen . }}selected{{ end }}>{{ . }}</option>
        {{ end }}
      </select>
    </div>
    <br />

    <div>
      <label for="openLinksInNewTab">Open links in a new tab:</label>
      <input type="checkbox" name="openLinksInNewTab" id="openLinksInNewTab" {{ if $up.OpenLinksInNewTab }}checked{{ end }}>
    </div>
    <br />
    
    <input type="submit" value="Save Preferences">
  </form>

  <hr />

  <p>{{ $length }} subscriptions:</p>
  <form method="POST" action="/settings/subscribe">
    <textarea name="submit" rows="10" cols="50">{{ range .Data.UrlsAndErrors }}{{ .URL }}
{{ end }}</textarea>
    <br />
    <input type="submit" value="subscribe">
  </form>

  {{ if eq $length 0 }}
  <pre>
‚ÄºÔ∏è tutorial ‚ÄºÔ∏è

once you have subscribed to some feeds,
their posts will appear on your timeline.

note that all timelines are public ‚ÄºÔ∏è

here are some feed urls to play with
copy them into the text box above
and press [subscribe]

https://aco.bearblog.dev/feed/
https://brandonwrites.xyz/feed/
https://craigmod.com/index.xml
https://herman.bearblog.dev/feed/
https://j3s.sh/feed.atom
https://lili.bearblog.dev/feed/
https://meadow.cafe/feed/
https://reverie.bearblog.dev/feed/
https://roytang.net/blog/feed/rss/
https://sizeof.cat/index.xml
https://tiramisu.bearblog.dev/feed/
https://www.visakanv.com/feed/


/)/)
( . .)
( „Å•‚ô°
  </pre>
  {{ else }}
  <p>feed details</p>
  <p class="puny" style="margin-top: 2em;">Click on the little moon next to each feed to toggle it's <i>favorite</i> status. Unread items from these will appear at the very top of your feed.</p>
  {{ end }}

  <pre>{{ range .Data.UrlsAndErrors }}{{- $hasError := ne .Error "" -}}{{- $isFavorite := .IsFavorite }}<a href="javascript:void(0);" onclick="toggleFavoriteFeed('{{ .URL }}', this)" title="Toggle favorite feed" class="{{- if $isFavorite -}}favorite-link{{- else -}}not-favorite-link{{- end -}}"></a> <a href="/feeds/{{ .URL | escapeURL }}">{{ .URL }}</a> {{ if $hasError }}<span title="{{ .Error }}" style="cursor: pointer;">‚ö†Ô∏è</span>{{ end }}
{{ end }}</pre>
</main>

<script>
  // Initialize favorite toggle moons on page load
  document.addEventListener('DOMContentLoaded', function() {
    const favoriteLinks = document.querySelectorAll('.favorite-link');
    const notFavoriteLinks = document.querySelectorAll('.not-favorite-link');
    
    favoriteLinks.forEach(link => {
      if (!link.textContent.trim()) {
        link.textContent = 'üåï';
      }
    });
    
    notFavoriteLinks.forEach(link => {
      if (!link.textContent.trim()) {
        link.textContent = 'üåë';
      }
    });
  });

  function addFeed(feedUrl) {
    const textarea = document.getElementById('submit');
    const currentFeeds = textarea.value.trim();
    
    if (currentFeeds === '') {
      textarea.value = feedUrl;
    } else {
      textarea.value = currentFeeds + '\n' + feedUrl;
    }
    
    // Scroll textarea to bottom to show the newly added feed
    textarea.scrollTop = textarea.scrollHeight;
    
    // Focus the textarea
    textarea.focus();
  }

  function toggleFavoriteFeed(feedUrl, element) {
    const wasFavorite = element.textContent === 'üåï';
    const newFeedFavoriteStatus = !wasFavorite;

    // Update UI immediately
    element.textContent = newFeedFavoriteStatus ? 'üåï' : 'üåë';

    const encodedFeed = encodeURIComponent(feedUrl);
    fetch(`/api/v1/toggle-favorite-feed-status/${encodedFeed}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `new_is_favorite=${encodeURIComponent(newFeedFavoriteStatus)}`
    }).then(function (response) {
      if (response.status !== 200) {
        // Revert on error
        element.textContent = wasFavorite ? 'üåï' : 'üåë';
      }
    }).catch(function(error) {
      console.error('Error toggling favorite:', error);
      // Revert on error
      element.textContent = wasFavorite ? 'üåï' : 'üåë';
    });
  }
</script>

{{ template "tail" . }}
{{ end }}
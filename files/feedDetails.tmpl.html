{{ define "feedDetails" }}

{{ template "head" . }}
{{ template "nav" . }}

<div id="loading-indicator" class="loading-indicator" style="display: none;">
	<div class="loading-indicator__spinner"></div>
</div>

<main class="feed-details">
	<!-- Feed Header -->
	<header class="feed-header">
		<div class="feed-title-section">
			<h1 class="feed-title">{{ .Data.Feed.Title }}</h1>
			<div class="feed-link">
				<a href="{{ .Data.Feed.Link }}" target="_blank" rel="noopener">
					{{ .Data.Feed.Link | printDomain }} â†—
				</a>
			</div>
		</div>

		{{ if .LoggedIn }}
		<div class="subscription-controls">
			{{ if .Data.IsSubscribed }}
			<button onclick="toggleSubscription(false)" class="btn btn-unsubscribe">
				Unsubscribe
			</button>
			{{ else }}
			<button onclick="toggleSubscription(true)" class="btn btn-subscribe">
				Subscribe
			</button>
			{{ end }}
		</div>
		{{ end }}
	</header>

	<!-- Feed Details -->
	<section class="feed-info">
		{{ if .Data.Feed.Description }}
		<div class="feed-description">
			<p>{{ .Data.Feed.Description }}</p>
		</div>
		{{ end }}
		
		<div class="feed-meta">
			<div class="meta-item">
				<strong>Items:</strong> {{ len .Data.Posts }}
			</div>
			<div class="meta-item">
				<strong>Unread:</strong> <span id="unread-counter">...</span>
			</div>
			{{ if .Data.FetchFailure }}
			<div class="meta-item fetch-error">
				<strong>Last Fetch Error:</strong> {{ .Data.FetchFailure }}
			</div>
			{{ end }}
		</div>
	</section>

	<!-- Controls -->
	<section class="feed-controls">
		<h2>Feed Items</h2>
		<div class="bulk-actions">
			<button onclick="markAllAsRead()" class="btn btn-secondary">
				Mark All as Read
			</button>
			<button onclick="markAllAsUnread()" class="btn btn-secondary">
				Mark All as Unread
			</button>
		</div>
	</section>

<ul id="feed-items-container">
	{{ range .Data.Posts }}
	{{ template "feed_list_item" . }}
	{{ end }}
</ul>

<script>
	(function () {
		document.getElementById("loading-indicator").style.display = "none";
		refreshUnreadCounter();
	})();

	function refreshUnreadCounter() {
		const unreadCounter = document.querySelector("#unread-counter");
		if (unreadCounter) {
			const numUnreadItems = document.querySelectorAll("#feed-items-container a.unread").length;
			unreadCounter.innerHTML = numUnreadItems;
		}
	}

	function toggleReadStatus(event) {
		const element = event.target;
		const titleElement = element.parentElement.querySelectorAll("a")[1];
		const isRead = titleElement.className === "read";

		const postUrl = encodeURIComponent(titleElement.href);
		const newReadStatus = !isRead;

		const allSameUrlElements = Array
			.from(document.querySelectorAll(`a[href='${titleElement.href}']`))
			.map(linkHolderElement => {
				const anchors = linkHolderElement.parentElement.querySelectorAll("a");
				return {
					emojiHolder: anchors[0],
					title: anchors[1],
				};
			});

		allSameUrlElements.forEach(els => {
			els.title.className = newReadStatus ? "read" : "unread";
			els.emojiHolder.innerText = newReadStatus ? "ðŸ“œ" : "ðŸ’Œ";
		});

		setReadStatus(postUrl, newReadStatus).then(function (response) {
			if (response.status !== 200) {
				// undo the change
				allSameUrlElements.forEach(els => {
					els.title.className = isRead ? "read" : "unread";
					els.emojiHolder.innerText = isRead ? "ðŸ“œ" : "ðŸ’Œ";
				});
			}

			refreshUnreadCounter();
		});
	}

	async function visitLink(event) {
		event.preventDefault();

		document.getElementById("loading-indicator").style.display = "block";

		const element = event.target;
		const postUrl = encodeURIComponent(element.href);

		const allSameUrlElements = Array
			.from(document.querySelectorAll(`a[href='${element.href}']`))
			.map(linkHolderElement => {
				return linkHolderElement.parentElement.querySelectorAll("a")[0];
			});

		allSameUrlElements.forEach(el => {
			el.className = "read";
			el.innerText = "ðŸ“œ";
		});

		// Always mark the post as read
		await setReadStatus(postUrl, true);

		const openInNewTab = {{ if .Data.UserPreferences.OpenLinksInNewTab }}true{{ else }}false{{ end }};
		if (openInNewTab || event.ctrlKey || event.metaKey) {
			// Ctrl or Cmd was pressed, open the link in a new tab, which is the default behavior
			window.open(element.href, "_blank");

			// now that the link was opened in a new tab, we can hide the loading indicator
			document.getElementById("loading-indicator").style.display = "none";
		} else {
			// Ctrl or Cmd was not pressed, navigate to the link in the current tab
			window.location.href = element.href;
		}
	}

	function setReadStatus(postUrl, newReadStatus) {
		postUrl = encodeURIComponent(postUrl);
		return fetch(`/api/v1/set-post-read-status/${postUrl}`, {
			method: "POST",
			headers: {
				"Content-Type": "application/x-www-form-urlencoded"
			},
			body: `new_has_read=${encodeURIComponent(newReadStatus)}`
		});
	}

	async function markAllAsRead() {
		const unreadLinks = document.querySelectorAll("#feed-items-container a.unread");
		const promises = [];

		unreadLinks.forEach(linkElement => {
			// Update UI immediately
			const emojiElement = linkElement.parentElement.querySelector("a.toggle-read-status-emoji");
			linkElement.className = "read";
			emojiElement.innerText = "ðŸ“œ";

			// Queue API call
			const postUrl = encodeURIComponent(linkElement.href);
			promises.push(setReadStatus(postUrl, true));
		});

		// Execute all API calls
		try {
			await Promise.all(promises);
			refreshUnreadCounter();
		} catch (error) {
			console.error("Error marking all as read:", error);
			// Could add error handling here to revert UI changes if needed
		}
	}

	async function markAllAsUnread() {
		const readLinks = document.querySelectorAll("#feed-items-container a.read");
		const promises = [];

		readLinks.forEach(linkElement => {
			// Update UI immediately
			const emojiElement = linkElement.parentElement.querySelector("a.toggle-read-status-emoji");
			linkElement.className = "unread";
			emojiElement.innerText = "ðŸ’Œ";

			// Queue API call
			const postUrl = encodeURIComponent(linkElement.href);
			promises.push(setReadStatus(postUrl, false));
		});

		// Execute all API calls
		try {
			await Promise.all(promises);
			refreshUnreadCounter();
		} catch (error) {
			console.error("Error marking all as unread:", error);
			// Could add error handling here to revert UI changes if needed
		}
	}
	async function toggleSubscription(shouldSubscribe) {
		const feedUrl = encodeURIComponent('{{ .Data.FeedURL }}');
		
		try {
			const response = await fetch(`/api/v1/toggle-subscription/${feedUrl}`, {
				method: "POST",
				headers: {
					"Content-Type": "application/x-www-form-urlencoded"
				},
				body: `subscribe=${encodeURIComponent(shouldSubscribe)}`
			});

			if (response.ok) {
				// Reload the page to reflect the new subscription status
				window.location.reload();
			} else {
				console.error("Error toggling subscription:", response.statusText);
				alert("Error updating subscription. Please try again.");
			}
		} catch (error) {
			console.error("Error toggling subscription:", error);
			alert("Error updating subscription. Please try again.");
		}
	}
</script>

{{ template "tail" . }}
{{ end }}